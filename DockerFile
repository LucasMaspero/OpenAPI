# Node & Java Base
FROM timbru31/java-node

# Arguments
ARG BUILD_COUNTER

# Initialize
WORKDIR /.
COPY . .

# Step 1: Install Node Packages
RUN npm install

# Step 2: Validate Specification File
RUN npm run validate-spec

# Step 3: Generate .NET Core API Service Stubs
RUN npm run generate-service-dotnetcore -- --additional-properties=packageVersion=$BUILD_COUNTER

# DotNet Base
FROM mcr.microsoft.com/dotnet/core/sdk:3.1

# Copying files between stages
COPY --from=0 . .

# Specifying NuGet Id
WORKDIR /Output/SecurityService/NetCore/src/Org.OpenAPITools
RUN sed -i 's/\$id\$/PPA.FIP.Security.Specification/' Org.OpenAPITools.nuspec

# Step 4: Build .NET Core API Service Stubs
RUN dotnet build

# Step 5: Create NuGet Package from Service Stubs
RUN dotnet pack -p:NuspecFile=Org.OpenAPITools.nuspec